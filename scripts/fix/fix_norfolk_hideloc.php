<?php
# Notify by email of unread chats

require_once dirname(__FILE__) . '/../../include/config.php';
require_once(IZNIK_BASE . '/include/db.php');


$locs = $dbhr->preQuery("SELECT id FROM locations WHERE LOCATE('POINT', AsText(locations.geometry)) > 0");

error_log("Found polygons: " . count($locs));
$count = 0;

foreach ($locs as $loc) {
    try {
        $inters = $dbhr->preQuery("SELECT locations.id FROM locations LEFT JOIN locations_excluded ON locations_excluded.locationid = locations.id WHERE locations_excluded.locationid IS NULL AND locations.geometry IS NOT NULL AND ST_Intersects(locations.geometry, ST_GeomFromText('POLYGON((0.37105358738934 52.789306463675,0.36928301777988 52.794119594206,0.3573486027107 52.809704110419,0.36332227860239 52.833312040951,0.36470582034326 52.833933730936,0.3632551003901 52.833743278802,0.36127464066917 52.843272497455,0.36213406189373 52.850593251982,0.36698104789618 52.852530831592,0.36951226210652 52.851602631632,0.36317064205518 52.845912679584,0.37114420336472 52.85025534617,0.37565084930336 52.850686723763,0.37929869436437 52.859014492323,0.38653252409194 52.865155035108,0.38922910035063 52.865580128837,0.39689084171868 52.873585490571,0.39977732506865 52.872403062771,0.39707850254933 52.874614917998,0.40422944811951 52.879378462244,0.42042130500607 52.883460266975,0.42754224637813 52.88444697393,0.43019746199834 52.883387293874,0.42880868834815 52.888088274131,0.43808873498756 52.888983414898,0.4453200363729 52.896449689858,0.4480595681975 52.904577393791,0.45125524147318 52.903566340445,0.45436197203561 52.910481300829,0.46338977514647 52.914858056263,0.47404838829329 52.924629083211,0.47954223705825 52.935614155156,0.49880359124972 52.958956373294,0.52067701030161 52.971264761534,0.53500833358979 52.976979519029,0.55852227844603 52.978615781854,0.57786362304388 52.983585256707,0.60761593098609 52.976385659564,0.62659473290542 52.976331792742,0.62753907063446 52.976893661375,0.62431050362975 52.977212341615,0.63005520294088 52.978458486558,0.62760074964946 52.979038904992,0.6305930517347 52.981080640699,0.63888828500171 52.97893707579,0.64288949547518 52.980729448543,0.63920598546562 52.97918723132,0.63201130324964 52.98210765693,0.63715097866124 52.984388523001,0.66159900473084 52.988766933858,0.67429231973815 52.98945045419,0.70104269472988 52.988483864483,0.75565878711635 52.981718797367,0.77228366788566 52.984091948254,0.78848727898108 52.97969286753,0.81240296289138 52.978584098162,0.82289121224052 52.97993522923,0.82365368073424 52.978694916785,0.81647757570015 52.977705109851,0.83044026538292 52.979464221727,0.82770772037538 52.97832777951,0.83776355114814 52.978643801827,0.8413245607541 52.97914236193,0.83958998924213 52.980638082754,0.84377122290484 52.980752945644,0.84293993155873 52.982820656704,0.84495645587719 52.985884969451,0.84812836767409 52.987140856409,0.85082471066118 52.984546376353,0.8576609702132 52.987106239701,0.85768138502221 52.989716479095,0.84662631939923 52.991151919195,0.85236972384958 52.991255124209,0.90529671809339 52.981242818432,0.9015648280315 52.980878012317,0.91282037388706 52.979584526365,0.90619169132645 52.981922393544,0.92983582504093 52.976973471224,0.9130869983927 52.975996744868,0.92026416886021 52.9746972881,0.93621595533433 52.976205274766,0.95113451112558 52.975545976168,0.95472739104856 52.976427953254,0.95217168099985 52.978103126363,0.94276769509337 52.978359840698,0.95147217178908 52.978771633677,0.95347217280383 52.977596885467,0.95097736006292 52.979862301726,0.94692249869153 52.979550997507,0.95415724114496 52.979579080311,0.96360360872283 52.982506811137,0.96749747715157 52.979181839683,0.97767446605619 52.98015569991,0.99480759990937 52.977830032586,1.0568194145455 52.964343492628,1.1327657964989 52.950272857689,1.1805367450357 52.946656363902,1.2078869816695 52.946673346495,1.2502241357304 52.943467672158,1.2720250474432 52.939739711852,1.304859558412 52.932848022047,1.3461310757865 52.920199476385,1.3666547092661 52.909716996724,1.4145929436301 52.891801523092,1.4315471040701 52.883690240094,1.4767777824207 52.856226041964,1.5237951454632 52.833155819,1.5436428839755 52.820595308772,1.5769265705249 52.804889540399,1.5883154118063 52.801696522999,1.589012695014 52.799154939214,1.5937672636978 52.79600101367,1.6227683892631 52.78048079074,1.6597662916298 52.756057301247,1.6994911638559 52.723632941283,1.7105982625824 52.697491256703,1.730310446064 52.666566063902,1.7323165778656 52.658861744953,1.7340766520133 52.658250265893,1.7319355111042 52.657984963041,1.7389139110826 52.647300813452,1.7436721816513 52.633984973967,1.7457265313652 52.63433742434,1.7473346388783 52.625637854574,1.7453775555621 52.621334131023,1.742940261263 52.589505707298,1.7439210379236 52.580817890944,1.7473580039852 52.579197706402,1.7474898515639 52.57603777269,1.7446012630661 52.571066399296,1.7377662556833 52.56809631718,1.7403228034686 52.556704048204,1.7346868532142 52.556435148343,1.7425656025267 52.531679359271,1.7278445786321 52.530193248722,1.7262433478903 52.533108012596,1.7074333812048 52.539526981226,1.7044151269955 52.543978280862,1.6922624287546 52.544520324514,1.6914346956274 52.54675103461,1.6864782528883 52.549497431031,1.6821090076941 52.547318921977,1.6690919215183 52.549715314512,1.6611795274085 52.544619849962,1.6609878208683 52.541804734757,1.638569604715 52.536989638618,1.6401229426842 52.533335508452,1.6330926485024 52.531857842341,1.6383662666279 52.527492020015,1.6304110226122 52.525570446002,1.6311880602787 52.521512922245,1.6483696065197 52.514748037935,1.6490666812613 52.512680945153,1.6470301266837 52.50808761956,1.6561098945141 52.500965824668,1.6612620265393 52.500597679382,1.6741357078808 52.5033601449,1.6776744785191 52.49744145505,1.6834524679384 52.495663851013,1.6844849761724 52.493558994137,1.6838043621911 52.489546572028,1.6789391927827 52.486684517963,1.6775066006198 52.483558105195,1.6729038807797 52.481637597747,1.6728199533824 52.476213974487,1.6646992116748 52.474156954292,1.6612218107147 52.468263701425,1.6562008522637 52.467487230603,1.6525121223789 52.470538407374,1.6480530434834 52.471497521217,1.6445255230325 52.467959488896,1.6378262851733 52.466189628377,1.6356907704649 52.462353878114,1.6200054567045 52.462869721025,1.6087851753906 52.466225667824,1.6058514262131 52.471107187761,1.5881048765252 52.478242111804,1.5850460223247 52.476463878672,1.5698370886129 52.474179884143,1.5673711621057 52.471615921077,1.5678584934898 52.468265722395,1.5636352073809 52.46521948149,1.5644313867827 52.460949625101,1.5593460112239 52.45720972233,1.55065639853 52.458525445637,1.5460467099617 52.462456382553,1.5429979060418 52.461408091165,1.5375621140332 52.465867233824,1.5315417807354 52.467896806825,1.5259305920445 52.466929132179,1.5234005205648 52.461405935212,1.5179529512844 52.463563416805,1.5098302314758 52.461301576061,1.5013058943039 52.463798830817,1.4998109516987 52.465912091711,1.4969811850903 52.465516383065,1.4979292661453 52.467255039509,1.489957430838 52.468122242886,1.4825490164339 52.471443322264,1.4661088356832 52.464027889933,1.4642079756317 52.460230087129,1.4604516257747 52.457606566836,1.4476299788955 52.455569752596,1.440281505733 52.457483118536,1.4361720690188 52.461456317342,1.4367398565399 52.46411043415,1.429600433496 52.467467087676,1.4281491875132 52.470131263389,1.4215140883274 52.470479233531,1.4126211502118 52.463507002655,1.4128155570712 52.461148211878,1.435068118986 52.455510118256,1.4345961975756 52.452777668436,1.4367606038616 52.447582896759,1.4342695435521 52.444802962751,1.425666759454 52.44613220987,1.4236088457338 52.444767885311,1.4097101920783 52.443959088225,1.4080882137601 52.443200875681,1.4091769792943 52.441669048878,1.4036057941098 52.441634464331,1.3949980324028 52.438484764649,1.3927047877188 52.436378318486,1.3949763859779 52.434626412549,1.393865315213 52.433594250607,1.3880789320456 52.431624896958,1.3817607853464 52.431599926801,1.3775273421473 52.429413837973,1.3743909547055 52.430004538312,1.3722878110194 52.428055043544,1.3700655900849 52.428400020271,1.3699353001689 52.426596604176,1.3654477829845 52.427027682444,1.3595461341553 52.423669639423,1.3581600582907 52.420728137274,1.3603594280299 52.416569237833,1.3624711233372 52.415921749294,1.3629597449938 52.412639873706,1.3583952261786 52.410222362946,1.3480968078772 52.408545767374,1.3488357206557 52.403799722363,1.3375827537402 52.401513347004,1.3324299034435 52.393131597625,1.3244868517816 52.388651992262,1.3217937842684 52.389105553704,1.3179005402366 52.386929406643,1.3103829351237 52.388094763332,1.3032966478612 52.39126060616,1.2980451653023 52.391284195227,1.2949474962428 52.389078694897,1.288013583135 52.390237116975,1.2699747790793 52.378938564041,1.2617713252541 52.370645524783,1.2556634772646 52.370100834513,1.2517902590157 52.366030295667,1.2486364866077 52.365003602439,1.2347890060225 52.36449960993,1.2349332094176 52.361487749571,1.2321106864352 52.359796728937,1.2226500986614 52.358660209086,1.2156361940359 52.354936068898,1.1970132719201 52.361015838331,1.1918704800145 52.361333122562,1.1839856145302 52.358338530562,1.1790664593593 52.360539823379,1.1726305677962 52.359462681482,1.1648224118638 52.36170778888,1.1572227654976 52.361098102987,1.1522652717579 52.364145797813,1.1410301494454 52.366700156995,1.1254729756998 52.366688386221,1.1168156600464 52.37090544699,1.0809371951757 52.371934249707,1.0770092154353 52.372781469009,1.0698574173095 52.378082731226,1.0579386172235 52.376584964439,1.0518938538231 52.377735206387,1.0394717125261 52.376879183785,1.0378172590699 52.378725961001,1.0280886061978 52.378117820922,1.0159481217899 52.375244511504,1.0085593908828 52.375295317582,0.9995565616098 52.371091949223,0.98887979404514 52.371076639726,0.9820613700232 52.369071500156,0.9677147081014 52.369802571166,0.94869895752858 52.375536058578,0.94401261165863 52.378498731719,0.9420706777636 52.382491111576,0.93828035558959 52.384776451495,0.93854594779918 52.386207059677,0.93197028947873 52.388393312856,0.92901301837904 52.38782270992,0.92462459028632 52.389594444335,0.91485453906665 52.388323130021,0.90666282959586 52.385338408375,0.89519223606943 52.38802068912,0.8928592155111 52.390355128172,0.88267521273155 52.39131461574,0.87657829128701 52.389478298412,0.86860423583421 52.389902496761,0.8586033268484 52.394743525917,0.85883821828155 52.397648273066,0.85717002675708 52.398999131929,0.84265940413802 52.400354711739,0.83717265464657 52.399588107202,0.82911404023228 52.394381438001,0.81653804443267 52.392974867687,0.81450899316491 52.390476165243,0.80989692805531 52.389082167525,0.79785446373877 52.390799886731,0.78764954730372 52.386046857106,0.7751554845322 52.38588511146,0.77201623447991 52.38936390287,0.767686371323 52.389915983564,0.75602892107612 52.383829948477,0.7491223183552 52.382744353261,0.74268334830772 52.387747940459,0.74353467920136 52.392252991046,0.7402522430213 52.392684421452,0.73930679444374 52.394697537162,0.72294824133108 52.393267971422,0.69645045473897 52.396422770639,0.68606734313136 52.398762049973,0.67371384807176 52.404668695964,0.67017464954157 52.408738329922,0.67553231877993 52.414884783845,0.68652600138383 52.424473436702,0.69307835927435 52.427243595687,0.69786525981151 52.432845350437,0.71794505169569 52.445066364002,0.72062364744152 52.449145400279,0.70795214741265 52.452204653999,0.6961882818419 52.45058402586,0.68568948862397 52.452732378801,0.68026118804876 52.454224383854,0.67369069409993 52.4598781895,0.66852352970193 52.462055320472,0.66525673258658 52.461697364378,0.65804488830204 52.456835062203,0.65311219284647 52.456529507505,0.64888522367227 52.45248091951,0.64712465137265 52.45319225354,0.6439318034506 52.450615073627,0.63055697514423 52.449649904317,0.6289165858008 52.450431926328,0.6315084384205 52.453633548009,0.62210908475147 52.454006059888,0.62111525462396 52.452294207962,0.62357646335679 52.450832979823,0.61730863539342 52.448476241566,0.61156775604382 52.449887570224,0.61018797240242 52.451196909504,0.61118701014384 52.452284588024,0.59917162931106 52.453776113891,0.58666247981813 52.451480208774,0.57427746379355 52.451515828984,0.55652297036052 52.455598336228,0.54393981797543 52.449817313717,0.53119095046599 52.45299581292,0.52536023106363 52.447749732864,0.51829949708567 52.4500695586,0.51522839611896 52.448820055061,0.50915090960994 52.450166916937,0.50189538818866 52.44964442479,0.4977365031724 52.446850054576,0.48720348671431 52.447312293449,0.47985341930072 52.445145513945,0.47742211466018 52.446300906843,0.46895775329948 52.444853847322,0.46107755423779 52.446828529463,0.45869825175811 52.444540663709,0.4531493800605 52.447341354173,0.45156890875376 52.44724189111,0.45111785965007 52.445400440498,0.44722812131804 52.446943353357,0.44081668122023 52.443055955117,0.44082962049098 52.440310053229,0.43005457190566 52.436168670374,0.42624279506865 52.44228764571,0.42748048625037 52.443384526202,0.42546496968066 52.44449523662,0.42504241586482 52.453277602935,0.43021731280986 52.454225296157,0.4037758135456 52.464922644544,0.39360180179529 52.475104161309,0.38239152742096 52.479115715748,0.368828570738 52.49552165785,0.36874731952636 52.500752636387,0.36377735524672 52.498511243964,0.36109165148239 52.500418346586,0.34671613367254 52.501264640493,0.33261920973217 52.50871624902,0.31998538441711 52.507238132722,0.31897312273767 52.512588957336,0.31103995141547 52.513203708617,0.28030975670324 52.508138223056,0.25814875551812 52.507296284444,0.24771141365456 52.499472684932,0.24046140192636 52.508767540614,0.2379892835533 52.506872822023,0.21531037426372 52.518056772986,0.20779155983445 52.519218877494,0.21673287033998 52.522038190096,0.21831565906252 52.520446489202,0.22137648775735 52.522730712517,0.22484343109546 52.520967778731,0.22649554760197 52.522007691187,0.22405700533067 52.523494226952,0.23226266637268 52.527494292932,0.22727596730226 52.532154717753,0.22196292014926 52.528505559502,0.21661042360032 52.531636524817,0.20980371379299 52.529672125902,0.20751686789578 52.533435992986,0.21481563522808 52.537757238899,0.20554198181401 52.544991534611,0.21290724549192 52.544822560875,0.21603028793193 52.54655547921,0.2162973565925 52.548693352898,0.21061423192724 52.546566791724,0.20681044941137 52.547487621101,0.20637941588851 52.554243687559,0.21576957726041 52.555786784719,0.21891136315216 52.56018195895,0.21398122037705 52.560733863588,0.2084078302589 52.563198512228,0.20730353266716 52.565157905852,0.20849566243092 52.567178833785,0.21779751345192 52.569075846923,0.2200858632349 52.572188455197,0.21630429543313 52.575111776762,0.21745446600616 52.579036234767,0.20428396364459 52.579685970828,0.2012169288792 52.58234915979,0.19887326040766 52.588672235402,0.20082091582783 52.591384105897,0.19552501770626 52.591695593437,0.1956000177018 52.594994516934,0.1968330542031 52.594758490327,0.19329918029046 52.598482125524,0.1932725699409 52.601110298529,0.2031930810182 52.602729137357,0.20728911788532 52.611397137297,0.21906340915687 52.614119486104,0.21254106356828 52.617522884087,0.22097766833632 52.621407116945,0.19370322041801 52.633862070231,0.18734902544464 52.640111619965,0.17943084971033 52.64295078157,0.17159924475407 52.650034096877,0.1712691633902 52.652354860684,0.18001531669327 52.652234675815,0.17777967513112 52.655299006194,0.1855175534444 52.655260869651,0.1861064930495 52.671741221262,0.18275522880856 52.671699627226,0.18251276858441 52.672859651145,0.18504396831213 52.673629455979,0.18639388941053 52.677495636302,0.17154646564131 52.678258723496,0.16806316301378 52.68016147313,0.15881877937991 52.679294367897,0.15524451436692 52.681825162125,0.15802888042353 52.707439545134,0.16931325750222 52.724204818126,0.17330507522265 52.73764000206,0.18800385086062 52.73495614425,0.19395983132734 52.737943863043,0.19249541965871 52.739082452913,0.19656391290797 52.738404645235,0.19844622054827 52.741862382591,0.23485041165226 52.759874318111,0.2739006180817 52.772415526864,0.24677390476574 52.784135335686,0.25368868935707 52.792175539055,0.26259701849849 52.795668491554,0.25486970190272 52.796967593568,0.26439730369369 52.803220118548,0.27470483432142 52.823842196244,0.21960592635457 52.827855845726,0.21845485505372 52.834603658058,0.21134368801585 52.841817753002,0.21276293848639 52.846567071366,0.22784481420354 52.851971619676,0.23309111678977 52.84800007427,0.23989814435729 52.851401253391,0.24311362147439 52.855623590357,0.25384744674003 52.856807719076,0.26686601457712 52.849313762557,0.27029213988805 52.843922094382,0.27576366124277 52.843043991278,0.28367620313732 52.83780231462,0.28830320014465 52.837035165773,0.29348817904079 52.839308111193,0.28810122783112 52.848414416435,0.28933809136546 52.85162419797,0.29207299102657 52.852218856589,0.31985936605755 52.833453075201,0.32597738074879 52.831544674585,0.33479127175538 52.831383255435,0.33692506751149 52.833182023751,0.33643744341858 52.835551298401,0.32397773437509 52.838057565765,0.3169879302495 52.845813526313,0.31333852327247 52.854468052703,0.31325201241419 52.867950179701,0.30999208334353 52.876427865743,0.31775605175297 52.887619522924,0.34522170755796 52.891864179535,0.35057276564248 52.891312279808,0.35293536910045 52.889310542832,0.3542849893813 52.880964823463,0.34510107480768 52.865561842609,0.34819212689882 52.85118017725,0.35596475137611 52.845870765386,0.35934279446676 52.831584705076,0.35479659882551 52.822258940235,0.35406201098654 52.810182105342,0.37105358738934 52.789306463675))')) AND locations.id = ?;", [
            $loc['id']
        ]);

        foreach ($inters as $inter) {
            $dbhm->preExec("INSERT INTO locations_excluded (locationid, norfolk) VALUES (?, 1);", [
                $inter['id']
            ]);
            $count++;

            if ($count % 1000 === 0) {
                error_log($count);
            }
        }
    } catch (\Exception $e) {
        error_log("Exception " . $e->getMessage() . " on " . $loc['id']);
    }
}

error_log("Count $count");