language: php
php:
  - 7.0
sudo: enabled
addons:
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server
      - mysql-client
services:
  - mysql
branches:
  only:
    master
before_install:
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('new_password') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo mysql_upgrade
  - sudo service mysql restart
  - pecl install mailparse
  - travis_retry composer self-update
  - cd composer
  - composer install
  - cd ..
  - sudo cp install/iznik.conf.php /etc/iznik.conf
  - mysql -e 'CREATE DATABASE IF NOT EXISTS iznik;'
  - mysql -u root --default-character-set=utf8 iznik < install/schema.sql
  - php install/testenv.php
script: phpunit --bootstrap composer/vendor/autoload.php test/ut/php