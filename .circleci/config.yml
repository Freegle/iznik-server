version: 2
jobs:
  build:
    environment:
      - STANDALONE=TRUE
    docker:
      - image: freeglegeeks/server:ut
    steps:
      - checkout
      - run: ps -ef
      - run: service mysql restart
      - run: service redis-server restart
      - run: ps -ef
      - run: cd composer; wget https://getcomposer.org/composer-1.phar; php composer-1.phar install; cd ..
      - run: php scripts/cron/background.php&
      - run: php scripts/cron/exports.php&

      - run: cp install/iznik.conf.php /etc/iznik.conf
      - run: sed -ie "s/'GOOGLE_VISION_KEY', 'zzz'/'GOOGLE_VISION_KEY', ' \GOOGLE_VISION_KEY'/g" /etc/iznik.conf
      - run: sed -ie "s/'TWITTER_CONSUMER_KEY', 'zzzz'/'TWITTER_CONSUMER_KEY', ' \TWITTER_CONSUMER_KEY'/g" /etc/iznik.conf
      - run: sed -ie "s/'TWITTER_CONSUMER_SECRET', 'zzzz'/'TWITTER_CONSUMER_SECRET', ' \TWITTER_CONSUMER_SECRET'/g" /etc/iznik.conf
      - run: sed -ie "s/'AZURE_CONNECTION_STRING', 'zzzz'/'AZURE_CONNECTION_STRING', ' \AZURE_CONNECTION_STRING'/g" /etc/iznik.conf
      - run: sed -ie "s/'PLAYGROUND_TOKEN', 'zzzz'/'PLAYGROUND_TOKEN', ' \PLAYGROUND_TOKEN'/g" /etc/iznik.conf
      - run: sed -ie "s/'PLAYGROUND_SECRET', 'zzzz'/'PLAYGROUND_SECRET', ' \PLAYGROUND_SECRET'/g" /etc/iznik.conf
      - run: sed -ie 's/\/var\/www\/iznik.mt.dbg\//\//g' test/ut/php/phpunit.xml

      - run: cd http/api; ../../composer/vendor/bin/phpunit --stderr --bootstrap ../../composer/vendor/autoload.php -dxdebug.coverage_enable=1 --coverage-clover ../../test/ut/php/clover.xml --configuration ../../test/ut/php/phpunit.xml ../../test/ut/php/
      - run: php ../../composer/vendor/bin/php-coveralls -v
